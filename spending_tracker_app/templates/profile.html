{% extends 'base.html' %}
{% load static %}
{% block title %}Profile - Spending Tracker{% endblock %}
{% block content %}
<h1>Profile</h1>
<p>Total Earned: {{ total_earned }} {{ display_currency }}</p>
<p>Total Spent: {{ total_spent }} {{ display_currency }}</p>
<p>AI Recommendation: {{ ai_recommendation }}</p>

<h2>Settings</h2>
<div class="login-container">
    <!-- Change Password -->
    <h3>Change Password</h3>
    <form method="post" action="{% url 'spending_tracker_app:change_password' %}">
        {% csrf_token %}
        <label for="old_password">Old Password:</label>
        <input type="password" name="old_password" id="old_password" required>
        <label for="new_password">New Password:</label>
        <input type="password" name="new_password" id="new_password" required>
        <button type="submit">Change Password</button>
        {% if error %}<p style="color: #ff6666;">{{ error }}</p>{% endif %}
    </form>

    <!-- Clear Records -->
    <h3>Clear All Records</h3>
    <button onclick="confirmClearRecords()">Clear All Records</button>

    <!-- Change Preferred Currency -->
    <h3>Change Preferred Currency</h3>
    <form method="post" action="{% url 'spending_tracker_app:update_currency' %}">
        {% csrf_token %}
        <label for="preferred_currency">Preferred Currency:</label>
        <select name="preferred_currency" id="preferred_currency" required>
            <option value="EUR" {% if request.session.preferred_currency == 'EUR' %}selected{% endif %}>EUR</option>
            <option value="GBP" {% if request.session.preferred_currency == 'GBP' %}selected{% endif %}>GBP</option>
            <option value="JPY" {% if request.session.preferred_currency == 'JPY' %}selected{% endif %}>JPY</option>
        </select>
        <button type="submit">Update Currency</button>
    </form>
</div>

<script>
    function confirmClearRecords() {
        if (confirm("Are you sure you want to clear all records? This action cannot be undone.")) {
            fetch('/clear_records/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Records cleared successfully.");
                    location.reload();
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => alert(`Failed to clear records: ${error}`));
        }
    }
</script>
{% endblock %}