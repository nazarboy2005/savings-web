{% extends 'base.html' %}
{% load static %}
{% block title %}Profile - Spending Tracker{% endblock %}
{% block content %}
    <h1>User Profile</h1>
    <p>View your financial overview and recommendations.</p>

    <div class="plan-section">
        <label for="monthlyBudget">Set Monthly Budget (QAR):</label>
        <input type="number" id="monthlyBudget" min="0" step="0.01" placeholder="Enter budget...">
        <button onclick="setBudget()">Set Budget</button>
    </div>

    <div class="plan-summary">
        <p>Total Earned: {{ total_earned }} {{ display_currency }}</p>
        <p>Total Spent: {{ total_spent }} {{ display_currency }}</p>
        <p id="budgetStatus"></p>
        <p>{{ ai_recommendation }}</p>
    </div>

    <h2>Your Plans</h2>
    <table id="planTable">
        <thead>
            <tr>
                <th>Plan</th>
                <th>Description</th>
                <th>Category</th>
                <th>From Date</th>
                <th>To Date</th>
                <th>Left Money</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for plan in plans %}
            <tr>
                <td>{{ plan.type|title }}</td>
                <td>{{ plan.description }}</td>
                <td>{{ plan.categories.all|join:", " }}</td>
                <td>{{ plan.from_date|date:"Y-m-d" }}</td>
                <td>{{ plan.to_date|date:"Y-m-d" }}</td>
                <td>{{ plan.left_money }} {{ display_currency }}</td>
                <td>{{ plan.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script src="{% static 'js/script.js' %}"></script>
    <script>
        function setBudget() {
            const budget = parseFloat(document.getElementById("monthlyBudget").value);
            if (isNaN(budget) || budget <= 0) {
                alert("Please enter a valid budget!");
                return;
            }
            console.log("Setting monthly budget:", budget);
            // Comment out or remove this fetch if you donâ€™t want to implement /set_budget/
            /*
            fetch('/set_budget/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ budget: budget })
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("Budget set:", data);
                updatePlanStatus();
            })
            .catch(error => {
                console.error('Error setting budget:', error);
                alert("Failed to set budget. Check console for details.");
            });
            */
            alert("Budget setting functionality not implemented. Please contact admin.");
        }
    </script>
{% endblock %}